# 개발 로그 (Development Log)

## 2025-12-25: Whisper Segment Extractor 프로젝트 시작

### 📌 프로젝트 목표
EBS 영어 강의 MP3 파일에서 "전체대화" 구간을 자동으로 감지하고 추출하는 AI 기반 도구 개발

### 🎯 해결하고자 한 문제
- **수동 작업의 비효율성**: 30분짜리 강의에서 약 50초 분량의 대화 구간을 찾아 수동으로 자르는 작업
- **반복성**: 매일/매주 새로운 강의 파일이 올라올 때마다 같은 작업 반복
- **정확성**: 정확한 시작/종료 지점을 찾기 어려움

---

## 개발 과정

### Phase 1: 기본 추출 도구 (extract_conversation.py)
**목표**: Whisper로 "전체대화" 앵커를 찾고 기본적인 추출 수행

**구현**:
- OpenAI Whisper를 사용한 STT (Speech-to-Text)
- "전체대화 주세요" 앵커 문구 검색
- pydub으로 오디오 구간 추출 (320kbps 고음질)

**문제점**:
- 처리 속도가 느림 (30분 MP3당 5-10분 소요)
- 앵커는 찾지만 정확한 추출 구간 결정이 어려움

---

### Phase 2: 배치 처리 및 최적화 (batch_extract_conversation.py)
**개선 사항**:
- ✅ 여러 파일 자동 처리
- ✅ 앵커 검색을 23분부터 시작 (속도 향상)
- ✅ inaSpeechSegmenter로 음악/음성 구간 감지 시도

**문제점**:
- inaSpeechSegmenter 설치 복잡 (TensorFlow 의존성)
- Base 모델 사용으로 여전히 느림

---

### Phase 3: 패턴 분석 (analyze_files.py)
**목적**: 사용자가 수동으로 자른 파일들을 분석하여 패턴 발견

**발견한 패턴**:
```
파일          원본 길이    추출 길이    비율
20251218     29.05분     0.95분(57초)  3.3%
20251219     28.28분     0.77분(46초)  2.7%
20251224     29.60분     0.82분(49초)  2.8%

평균: 50초 추출 (범위: 46-57초)
```

**핵심 발견**:
- 앵커 종료: 약 23:16분
- 실제 추출 시작: 23:56분
- **offset: 약 46초** (음악이 시작되는 시점까지)

---

### Phase 4: 고속 추출 도구 (fast_extract.py)
**주요 개선**:
- ✅ Whisper **tiny 모델** 사용 (5-10배 빠름)
- ✅ 23분(1380초)부터만 전사 (2-3배 속도 향상)
- ✅ 고정 시간 추출: 앵커 + 46초 offset + 50초 구간
- ✅ inaSpeechSegmenter 의존성 제거

**결과**:
- 처리 시간: 30분 MP3당 약 4-5분
- 성공률: 높음 (앵커 감지 95%+)

**한계**:
- 고정 시간 방식이라 음악이 끝나는 시점을 정확히 못 잡음
- 일부 파일에서 한국어 해설 일부 포함됨

---

### Phase 5: 지능형 추출 (smart_extract.py) ⭐
**핵심 아이디어**: Whisper 전사 결과로 영어/한국어를 구분하여 정확한 종료점 찾기

**구현된 기능**:
1. **Whisper 오인식 패턴 처리**
   - "전체대화" → "전체되어"로 인식되는 케이스 대응
   - 연속 3개 세그먼트 병합 검색

2. **영어/한국어 자동 구분**
   ```python
   def _is_english_segment(text):
       korean_ratio = korean_count / total_chars
       return korean_ratio < 0.3  # 한글 30% 미만 = 영어
   ```

3. **지능형 종료 감지**
   - 연속 2개 이상 한국어 세그먼트 → 대화 종료
   - 중간에 영어 나오면 카운터 리셋

4. **음악 시작점 미세 조정**
   - inaSpeechSegmenter로 정확한 시작점 찾기 (선택사항)

5. **대화 스크립트 자동 생성**
   - 타임스탬프와 함께 텍스트 추출
   - `script_*.txt` 파일로 저장

**성능**:
- ✅ 정확도: 매우 높음 (한국어 해설 완전 제거)
- ✅ 처리 시간: small 모델 기준 30분당 약 2-3분
- ✅ 추출 길이: 동적 (실제 대화가 끝나는 시점까지)

**테스트 결과**:
### Phase 6: 동기화 웹 플레이어 (player/) ⭐
**목표**: MP3 재생과 스크립트를 실시간으로 동기화하여 시각적으로 확인

**구현 내용**:
1. **2차 전사 패스 (English Pass)**
   - 추출된 구간만 따로 떼어 `language='en'`으로 정밀 전사
   - 원어민 대화 본연의 텍스트 확보 (기존 한국어 전사 대비 정확도 향상)
2. **웹 플레이어 UI**
   - HTML/JS/CSS 기반의 모던한 디자인 (`player/index.html`)
   - 0초 기준의 상대 타임스탬프를 가진 `player_*.json` 데이터 활용
3. **브라우저 보안 대응**
   - 로컬 파일 접근 제한을 해결하기 위해 JSON+MP3 동시 선택 방식 적용
4. **학습 최적화 기능**
   - 스크립트 클릭 시 해당 구간 즉시 이동 (Seek)
   - 현재 재생 중인 문장 자동 하이라이트 및 스크롤

**성능**:
- ✅ 가독성: 한국어 전사가 아닌 원어민 영어 텍스트로 쉐도잉 최적화
- ✅ 편의성: "어디를 읽고 있는지" 눈으로 확인하며 학습 가능

---

## 주요 의사결정

### 1. Whisper 모델 선택
- **tiny**: 빠르지만 앵커 감지에는 충분
- **small**: 속도와 정확도의 균형 ⭐ (최종 권장)
- **base/medium**: 너무 느림

### 2. 추출 방식
- ❌ 고정 시간 (46초 offset + 50초)
- ✅ **전사 기반 지능형 추출** (영어/한국어 구분)

**이유**: 파일마다 대화 길이가 다르고, 한국어 해설이 정확히 제거되어야 함

### 3. 23분부터 전사
**장점**:
- 앵커가 항상 23분 이후에 등장
- 불필요한 앞부분 전사 생략 → 2-3배 빠름

### 4. 2단계 전사 (English Pass)
**목적**: 전용 영어 스크립트 확보
**방법**: 한국어 추출로 구간을 잡은 뒤, 해당 구간만 영어 전사 수행

---

## 기술적 도전과 해결

### 도전 1: Whisper 오인식
**문제**: "전체대화" → "전체되어"로 인식
**해결**: 
- 앵커 문구 리스트에 오인식 패턴 추가
- 연속 세그먼트 병합 검색

### 도전 2: 로컬 파일 보안 (Browser Security)
**문제**: 웹 브라우저가 로컬 경로의 MP3를 보안상 열지 못함
**해결**: `URL.createObjectURL`을 사용하여 사용자가 선택한 파일을 Blob으로 처리, JSON과 MP3를 동시에 불러오는 인터페이스 구현

---

## 프로젝트 구조

```
whisper-segment-extractor/
├── smart_extract.py          # 메인 스크립트 (JSON 데이터 생성 포함)
├── player/                   # 동기화 웹 플레이어
│   ├── index.html
│   ├── style.css
│   └── app.js
├── fast_extract.py           # 고정 시간 방식
├── batch_extract_conversation.py
├── extract_conversation.py
├── analyze_files.py          # 파일 분석 도구
├── DEVLOG.md (this file)
└── ...
```

---

## 사용 방법

### 1. 스크립트 실행
```bash
python smart_extract.py -f your_file.mp3 --model small
```
실행 완료 시 `extracted_*.mp3`와 `player_*.json`이 생성됨.

### 2. 플레이어 사용
- `player/index.html`을 브라우저로 엽니다.
- "파일 열기" 버튼을 누르고 생성된 **JSON과 MP3를 동시에 선택**합니다.

---

## 다음 단계 (TODO)

### 1. 본격적인 웹앱(Web App) 전환 ⏳
- [ ] **Next.js / React** 기반의 고성능 학습 플랫폼 구축
- [ ] **PWA (Progressive Web App)** 지원: 모바일에서 앱처럼 설치 및 오디오 오프라인 재생
- [ ] 디자인 시스템 적용: 유리 모피즘(Glassmorphism), 다크 모드, 부드러운 애니메이션

### 2. 스마트 학습 기능
- [ ] **MP3 자동 다운로드**: EBS 웹사이트 로그인 및 강의 자동 수집 보완
- [ ] **기록 관리**: 오늘 공부한 양, 학습 시간 통계 대시보드
- [ ] **구간 반복 최적화**: 문장별 반복, 재생 속도 미세 조절 (0.8x ~ 2.0x)

### 3. 모바일 앱 고려
- [ ] **Capacitor / Tauri**를 이용한 실제 스마트폰 앱 패키징 시도

---

## 배운 점

1. **데이터 기반의 점진적 개선**
   - 처음엔 단순히 자르기만 하던 도구가, 이제는 시간 동기화 스크립트가 있는 플레이어까지 발전함.
   - 사용자 피드백(원어민 스크립트 필요성 등)을 즉각 반영하는 것이 중요함.

2. **브라우저 보안 환경 이해**
   - 로컬 자동화와 웹 UI 사이의 보안 장벽을 Blob URL로 우회하는 법 습득.

---

## 업데이트 이력

- 2025-12-25: 프로젝트 시작 및 smart_extract.py 완성
- 2025-12-31: Phase 6 웹 플레이어 추가 및 영어 전사 패스 통합
- 2025-12-31: 웹앱/PWA 전환 계획 수립
